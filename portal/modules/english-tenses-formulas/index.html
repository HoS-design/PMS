<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tenses Builder</title>
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/app.css">

  <style>
    /* HoS-Design Variablen */
    :root {
      --subject-color: #0ea5e9; /* Sky Blue für Englisch */
      --accent: #0ea5e9;
      --accent-light: #e0f2fe;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --bg-page: #f8fafc;
      --bg-card: #ffffff;
      --border: #e2e8f0;
      --radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --success-bg: #dcfce7;
      --success-text: #166534;
      --error-bg: #fee2e2;
      --error-text: #991b1b;
    }

    body {
      background-color: var(--bg-page);
      color: var(--text-main);
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding-bottom: 40px;
    }

    /* Layout Wrapper */
    .app-wrapper {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }

    /* Grid Layout */
    .hos-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    @media (min-width: 800px) {
      .hos-grid {
        grid-template-columns: 2fr 1fr;
        align-items: start;
      }
    }

    /* Cards */
    .hos-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      padding: 20px;
      margin-bottom: 20px;
    }
    .hos-card h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.1rem;
      color: var(--text-main);
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }

    /* Typography */
    .text-muted { color: var(--text-muted); font-size: 0.9rem; line-height: 1.5; }
    .text-small { font-size: 0.85rem; }
    .mono { font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; }

    /* Tabs */
    .hos-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
      overflow-x: auto;
    }
    .hos-tab {
      background: transparent;
      border: none;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .hos-tab:hover { background: var(--border); color: var(--text-main); }
    .hos-tab[aria-selected="true"] {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    /* Task Area */
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .tense-display {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    /* Formula Dropzone */
    .formula-area {
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: var(--radius);
      padding: 20px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
      transition: background 0.2s;
    }
    .formula-area.is-over {
      background: var(--accent-light);
      border-color: var(--accent);
    }
    .formula-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .formula-placeholder {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
    }

    /* Chips & Slots */
    .chip, .slot {
      display: inline-flex;
      align-items: center;
      padding: 8px 14px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.95rem;
      user-select: none;
      cursor: grab;
      transition: transform 0.1s, box-shadow 0.1s;
      border: 1px solid var(--border);
      background: white;
      box-shadow: var(--shadow-sm);
    }
    .chip:hover, .slot:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }
    .chip:active, .slot:active {
      cursor: grabbing;
    }
    .chip.dragging, .slot.dragging {
      opacity: 0.5;
    }

    /* Pool */
    .pool-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 16px;
      background: #f8fafc;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    /* Controls inside Slot */
    .slot {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #1e3a8a;
      gap: 8px;
      padding-right: 6px; /* Space for buttons */
    }
    .slot-controls {
      display: flex;
      gap: 2px;
    }
    .mini-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: #3b82f6;
      font-weight: bold;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .mini-btn:hover { background: rgba(59,130,246,0.1); }
    .plus-sign { color: var(--text-muted); font-weight: bold; margin: 0 4px; }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      font-size: 0.95rem;
      text-decoration: none;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
    }
    .btn-primary:hover { background: #0284c7; }
    
    .btn-secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .btn-secondary:hover { background: #f1f5f9; border-color: #cbd5e1; }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }
    .btn-ghost:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }

    .btn-danger {
      background: #fff;
      border: 1px solid #fecaca;
      color: #dc2626;
    }
    .btn-danger:hover { background: #fef2f2; }

    /* Feedback */
    .feedback-box {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .feedback-box.ok { background: var(--success-bg); color: var(--success-text); border: 1px solid #bbf7d0; }
    .feedback-box.bad { background: var(--error-bg); color: var(--error-text); border: 1px solid #fecaca; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* Overview List */
    .tense-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.1s;
    }
    .tense-list-item:hover { background: #f8fafc; }
    .tense-list-item:last-child { border-bottom: none; }
    .status-badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .status-new { background: #f1f5f9; color: var(--text-muted); }
    .status-ok { background: var(--success-bg); color: var(--success-text); }
    .status-bad { background: #fff7ed; color: #c2410c; }

    /* KPI Pills */
    .kpi-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    .kpi-pill {
      background: white;
      border: 1px solid var(--border);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .kpi-pill strong { color: var(--text-main); }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand-row">
      <img src="/chatisthisreal.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
      <div class="brand-title">
        <div class="badge-main is-english">English</div>
        <h1>Tenses Builder</h1>
      </div>
    </div>
    <div class="header-actions">
      <a href="/index.html" class="header-link">Startseite</a>
    </div>
  </header>

  <div class="app-wrapper">
    
    <div class="hos-tabs" role="tablist">
      <button class="hos-tab" type="button" role="tab" id="tab-train" aria-selected="true">Training</button>
      <button class="hos-tab" type="button" role="tab" id="tab-overview" aria-selected="false">Übersicht</button>
      <button class="hos-tab" type="button" role="tab" id="tab-settings" aria-selected="false">Einstellungen</button>
    </div>

    <main>
      
      <div id="panel-train" role="tabpanel">
        <div class="hos-grid">
          
          <section>
            <div class="hos-card">
              <div class="task-header">
                <div>
                  <span class="text-muted text-small" style="display:block; margin-bottom:4px;">Bilde die Zeitform:</span>
                  <div class="tense-display">
                    <span id="tenseName">Loading...</span>
                    <span id="focusTag" style="font-size:0.8rem; font-weight:normal; color:#64748b; margin-left:8px;"></span>
                  </div>
                </div>
                <div>
                  <button class="btn btn-secondary" type="button" id="randomBtn">Skip / Next</button>
                </div>
              </div>

              <div class="formula-area" id="dropzone">
                <div class="formula-row" id="formulaRow">
                  <span class="formula-placeholder">Bausteine hierher ziehen</span>
                </div>
              </div>

              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
                <div style="display:flex; gap:8px;">
                  <button class="btn btn-ghost text-small" type="button" id="undoBtn">Rückgängig</button>
                  <button class="btn btn-ghost text-small" type="button" id="clearBtn">Leeren</button>
                </div>
                <div style="display:flex; gap:8px;">
                   <button class="btn btn-secondary text-small" type="button" id="hintBtn" style="display:none;">Tipp?</button>
                   <button class="btn btn-secondary text-small" type="button" id="showBtn" style="display:none;">Lösung</button>
                   <button class="btn btn-primary" type="button" id="checkBtn">Prüfen</button>
                </div>
              </div>

              <div id="fb" class="feedback-box"></div>
              <p class="text-muted text-small" id="helpGateLine" style="margin-top:12px; text-align:right; min-height:1.2em;"></p>
            </div>

            <div class="hos-card">
              <h3>Bausteine</h3>
              <p class="text-muted text-small">Klicken oder Ziehen zum Hinzufügen.</p>
              <div class="pool-area" id="pool"></div>
            </div>
          </section>

          <aside>
            <div class="hos-card">
              <h3>Fortschritt</h3>
              <div class="kpi-row">
                <div class="kpi-pill">Streak: <strong id="streak">0</strong></div>
                <div class="kpi-pill">Genauigkeit: <strong id="acc">-</strong></div>
                <div class="kpi-pill">Gelernt: <strong id="covered">0/10</strong></div>
              </div>
              <p class="text-muted text-small" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                Gespeichert: <span id="savedAt">-</span>
              </p>
            </div>

            <div class="hos-card">
              <h3>Modus</h3>
              <div id="focusNote" class="text-muted text-small" style="margin-bottom:12px;">Adaptiv (alles gemischt)</div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-secondary text-small" id="clearFocusBtn">Fokus aufheben</button>
                <button class="btn btn-ghost text-small" id="saveBtn2">Jetzt speichern</button>
              </div>
            </div>

            <div class="hos-card" style="background:#f0fdf4; border-color:#bbf7d0;">
              <h3 style="border-color:#86efac; color:#166534;">Pro-Tipp</h3>
              <p class="text-small" style="color:#14532d; margin:0;">
                Bei <strong>Present simple</strong> (he/she/it) kommt oft ein <strong>-s</strong> dazu. Wir üben hier die allgemeine Struktur.
              </p>
            </div>
          </aside>

        </div>
      </div>

      <div id="panel-overview" role="tabpanel" hidden>
        <div class="hos-grid">
          <section class="hos-card">
            <h3>Alle Zeitformen</h3>
            <p class="text-muted text-small">Klicke auf eine Form, um sie gezielt zu üben.</p>
            <div id="tenseList"></div>
          </section>
          
          <aside class="hos-card">
            <h3>Gesamtstatistik</h3>
            <div style="display:grid; gap:10px;">
              <div class="kpi-pill">Versuche: <strong id="ovAttempts">0</strong></div>
              <div class="kpi-pill">Korrekt: <strong id="ovCorrect">0</strong></div>
              <div class="kpi-pill">Quote: <strong id="ovAcc">-</strong></div>
            </div>
            <button class="btn btn-secondary text-small" id="refreshBtn" style="margin-top:16px; width:100%;">Aktualisieren</button>
          </aside>
        </div>
      </div>

      <div id="panel-settings" role="tabpanel" hidden>
        <div class="hos-card" style="max-width:600px;">
          <h3>Einstellungen</h3>
          
          <div style="margin-bottom:20px;">
            <label style="display:flex; gap:12px; align-items:center; cursor:pointer;">
              <input type="checkbox" id="showCountsWrong" checked style="width:18px; height:18px;">
              <span class="text-muted">"Lösung anzeigen" zählt als Fehler</span>
            </label>
          </div>

          <h3>Schwierige Formen</h3>
          <p class="text-muted text-small">Diese Formen bereiten dir Probleme. Klick für Fokus-Training.</p>
          <div id="topListSettings" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;">-</div>

          <div style="border-top:1px solid var(--border); padding-top:20px; display:flex; gap:12px;">
            <button class="btn btn-primary" id="saveBtn">Speichern</button>
            <button class="btn btn-danger" id="resetBtn">Alle Daten löschen</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
  (function(){
    "use strict";

    var STORAGE_KEY = "hos_tenses_builder_v2";
    var FEEDBACK_MS = 2200; 

    var POOL = [
      "Person",
      "base form (I)",
      "past form (II)",
      "past participle (III)",
      "be (am/is/are)",
      "was/were",
      "has/have",
      "had",
      "been",
      "will",
      "going to",
      "ing",
      "base form (I) + s (he/she/it)" 
    ];

    var TENSES = [
      { id:"present_simple", name:"Present simple", formula:["Person","base form (I)"], note:"he/she/it often: +s" },
      { id:"present_progressive", name:"Present progressive", formula:["Person","be (am/is/are)","base form (I)","ing"] },
      { id:"past_simple", name:"Past simple", formula:["Person","past form (II)"] },
      { id:"past_progressive", name:"Past progressive", formula:["Person","was/were","base form (I)","ing"] },
      { id:"present_perfect_simple", name:"Present perfect simple", formula:["Person","has/have","past participle (III)"] },
      { id:"present_perfect_progressive", name:"Present perfect progressive", formula:["Person","has/have","been","base form (I)","ing"] },
      { id:"past_perfect_simple", name:"Past perfect simple", formula:["Person","had","past participle (III)"] },
      { id:"past_perfect_progressive", name:"Past perfect progressive", formula:["Person","had","been","base form (I)","ing"] },
      { id:"will_future", name:"Will future", formula:["Person","will","base form (I)"] },
      { id:"going_to_future", name:"Going-to future", formula:["Person","be (am/is/are)","going to","base form (I)"] }
    ];

    var state = {
      v: 2,
      streak: 0,
      focusId: null,
      stats: {}, 
      settings: { showCountsWrong: true },
      savedAt: "-"
    };

    var tabTrain = document.getElementById("tab-train");
    var tabOverview = document.getElementById("tab-overview");
    var tabSettings = document.getElementById("tab-settings");
    var panelTrain = document.getElementById("panel-train");
    var panelOverview = document.getElementById("panel-overview");
    var panelSettings = document.getElementById("panel-settings");

    var tenseName = document.getElementById("tenseName");
    var focusTag = document.getElementById("focusTag");
    var poolEl = document.getElementById("pool");
    var formulaRow = document.getElementById("formulaRow");
    var dropzone = document.getElementById("dropzone");
    var fb = document.getElementById("fb");

    var randomBtn = document.getElementById("randomBtn");
    var checkBtn = document.getElementById("checkBtn");
    var undoBtn = document.getElementById("undoBtn");
    var clearBtn = document.getElementById("clearBtn");
    var hintBtn = document.getElementById("hintBtn");
    var showBtn = document.getElementById("showBtn");
    var helpGateLine = document.getElementById("helpGateLine");

    var clearFocusBtn = document.getElementById("clearFocusBtn");
    var saveBtn = document.getElementById("saveBtn");
    var saveBtn2 = document.getElementById("saveBtn2");
    var resetBtn = document.getElementById("resetBtn");
    var showCountsWrong = document.getElementById("showCountsWrong");

    var streakEl = document.getElementById("streak");
    var accEl = document.getElementById("acc");
    var coveredEl = document.getElementById("covered");
    var savedAtEl = document.getElementById("savedAt");
    var focusNote = document.getElementById("focusNote");

    var tenseList = document.getElementById("tenseList");
    var ovAcc = document.getElementById("ovAcc");
    var ovAttempts = document.getElementById("ovAttempts");
    var ovCorrect = document.getElementById("ovCorrect");
    var refreshBtn = document.getElementById("refreshBtn");

    var topListSettings = document.getElementById("topListSettings");

    var dragging = { from: null, index: -1, token: null };
    var cur = { id: TENSES[1].id, built: [], history: [] };
    var nextTimer = null;

    function nowStamp(){
      try{
        var d = new Date();
        var pad = function(n){ return (n < 10 ? "0" : "") + n; };
        return pad(d.getDate()) + "." + pad(d.getMonth()+1) + "." + d.getFullYear() + " " + pad(d.getHours()) + ":" + pad(d.getMinutes());
      }catch(e){ return "-"; }
    }

    function getTenseById(id){
      for(var i=0;i<TENSES.length;i++) if(TENSES[i].id === id) return TENSES[i];
      return TENSES[0];
    }

    function getStat(id){
      if(!state.stats[id]) state.stats[id] = {attempts:0, correct:0, wrong:0, lastTs:0, failStreak:0};
      if(typeof state.stats[id].failStreak !== "number") state.stats[id].failStreak = 0;
      return state.stats[id];
    }

    function load(){
      try{
        var raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        var p = JSON.parse(raw);
        if(!p || p.v !== 2) return;
        state.streak = p.streak || 0;
        state.focusId = p.focusId || null;
        state.stats = p.stats || {};
        state.settings = p.settings || state.settings;
        state.savedAt = p.savedAt || "-";
      }catch(e){}
    }

    function save(){
      try{
        state.savedAt = nowStamp();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        savedAtEl.textContent = state.savedAt;
      }catch(e){
        savedAtEl.textContent = "Speichern fehlgeschlagen";
      }
    }

    function clearNextTimer(){
      if(nextTimer){ try{ clearTimeout(nextTimer); }catch(e){} }
      nextTimer = null;
    }

    function resetAll(){
      if(!confirm("Wirklich Statistik loeschen?")) return;
      try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
      state.streak = 0;
      state.focusId = null;
      state.stats = {};
      state.savedAt = "-";
      cur.built = [];
      cur.history = [];
      clearFeedback();
      clearNextTimer();
      pickNext();
      renderAll();
    }

    function weightForTense(t){
      var s = getStat(t.id);
      var attempts = s.attempts || 0;
      var wrong = s.wrong || 0;

      var errRate = attempts ? (wrong/attempts) : 0.0;
      var errBoost = 1 + (errRate * 3.0);
      var novelty = (attempts === 0) ? 2.0 : 1.0;

      var now = Date.now();
      var ageMin = s.lastTs ? Math.min(720, Math.max(0, (now - s.lastTs)/60000)) : 720;
      var spacing = 1 + Math.min(1.8, ageMin/240);
      var failBoost = 1 + Math.min(1.6, (s.failStreak || 0) * 0.18);

      return 1.0 * errBoost * novelty * spacing * failBoost;
    }

    function pickWeighted(list){
      var sum = 0, w = [], i;
      for(i=0;i<list.length;i++){
        w[i] = weightForTense(list[i]);
        sum += w[i];
      }
      var r = Math.random() * sum;
      var acc = 0;
      for(i=0;i<list.length;i++){
        acc += w[i];
        if(r <= acc) return list[i];
      }
      return list[list.length-1];
    }

    function setFocus(id){
      state.focusId = id;
      var t = getTenseById(id);
      focusNote.innerHTML = "<strong>Aktuell:</strong> Fokus " + t.name;
      focusTag.textContent = "(Fokus)";
    }

    function clearFocus(){
      state.focusId = null;
      focusNote.innerHTML = "Adaptiv (alles gemischt)";
      focusTag.textContent = "";
    }

    function updateHelpGateUI(){
      var st = getStat(cur.id);
      var fs = st.failStreak || 0;
      if(fs >= 2) hintBtn.style.display = "";
      else hintBtn.style.display = "none";

      if(fs >= 5) showBtn.style.display = "";
      else showBtn.style.display = "none";

      if(fs <= 1) helpGateLine.textContent = "";
      else if(fs <= 4) helpGateLine.textContent = "Tipp verfügbar.";
      else helpGateLine.textContent = "Lösung verfügbar.";
    }

    function pickNext(){
      clearNextTimer();
      var t;
      if(state.focusId){
        t = getTenseById(state.focusId);
      } else {
        t = pickWeighted(TENSES);
      }
      cur.id = t.id;
      cur.built = [];
      cur.history = [];
      clearFeedback();
      renderTask();
      renderFormula();
      renderPool();
      updateHelpGateUI();
    }

    function setFeedback(kind, html){
      fb.style.display = "block";
      fb.className = "feedback-box" + (kind ? (" " + kind) : "");
      fb.innerHTML = html;
    }
    function clearFeedback(){
      fb.style.display = "none";
      fb.className = "feedback-box";
      fb.innerHTML = "";
    }

    function renderTask(){
      var t = getTenseById(cur.id);
      tenseName.textContent = t.name;
    }

    function renderPool(){
      poolEl.innerHTML = "";
      POOL.forEach(function(token){
        var btn = document.createElement("div");
        btn.className = "chip";
        btn.textContent = token;
        btn.setAttribute("draggable", "true");

        btn.addEventListener("dragstart", function(e){
          dragging.from = "pool";
          dragging.index = -1;
          dragging.token = token;
          btn.classList.add("dragging");
          try { e.dataTransfer.setData("text/plain", token); } catch(err){}
        });

        btn.addEventListener("dragend", function(){
          btn.classList.remove("dragging");
          dragging.from = null;
          dragging.index = -1;
          dragging.token = null;
        });

        btn.addEventListener("click", function(){
          cur.history.push(cur.built.slice());
          cur.built.push(token);
          renderFormula();
          clearFeedback();
        });
        poolEl.appendChild(btn);
      });
    }

    function moveToken(idx, dir){
      var j = idx + dir;
      if(j < 0 || j >= cur.built.length) return;
      cur.history.push(cur.built.slice());
      var tmp = cur.built[idx];
      cur.built[idx] = cur.built[j];
      cur.built[j] = tmp;
      renderFormula();
      clearFeedback();
    }

    function removeToken(idx){
      cur.history.push(cur.built.slice());
      cur.built.splice(idx, 1);
      renderFormula();
      clearFeedback();
    }

    function renderFormula(){
      formulaRow.innerHTML = "";
      if(cur.built.length === 0){
        var span = document.createElement("span");
        span.className = "formula-placeholder";
        span.textContent = "Bausteine hierher ziehen";
        formulaRow.appendChild(span);
        return;
      }

      cur.built.forEach(function(token, idx){
        if(idx > 0){
          var plus = document.createElement("span");
          plus.className = "plus-sign";
          plus.textContent = "+";
          formulaRow.appendChild(plus);
        }

        var slot = document.createElement("div");
        slot.className = "slot";
        slot.title = "Klicken zum Entfernen";
        slot.setAttribute("draggable", "true");

        slot.addEventListener("dragstart", function(e){
          dragging.from = "formula";
          dragging.index = idx;
          dragging.token = token;
          slot.classList.add("dragging");
          try { e.dataTransfer.setData("text/plain", token); } catch(err){}
        });

        slot.addEventListener("dragend", function(){
          slot.classList.remove("dragging");
          dragging.from = null;
          dragging.index = -1;
          dragging.token = null;
        });

        slot.addEventListener("dragover", function(e){ e.preventDefault(); });
        slot.addEventListener("drop", function(e){
          e.preventDefault();
          if(dragging.from !== "formula") return;
          if(dragging.index === idx) return;
          cur.history.push(cur.built.slice());
          var moved = cur.built.splice(dragging.index, 1)[0];
          var target = idx;
          if(dragging.index < idx) target -= 1;
          cur.built.splice(target, 0, moved);
          renderFormula();
          clearFeedback();
        });

        var txt = document.createElement("span");
        txt.textContent = token;

        var controls = document.createElement("span");
        controls.className = "slot-controls";

        var left = document.createElement("button");
        left.type = "button";
        left.className = "mini-btn";
        left.textContent = "←";
        left.addEventListener("click", function(e){ e.stopPropagation(); moveToken(idx, -1); });

        var right = document.createElement("button");
        right.type = "button";
        right.className = "mini-btn";
        right.textContent = "→";
        right.addEventListener("click", function(e){ e.stopPropagation(); moveToken(idx, +1); });

        controls.appendChild(left);
        controls.appendChild(right);
        slot.appendChild(txt);
        slot.appendChild(controls);
        slot.addEventListener("click", function(){ removeToken(idx); });
        formulaRow.appendChild(slot);
      });
    }

    function arraysEqual(a,b){
      if(a.length !== b.length) return false;
      for(var i=0;i<a.length;i++) if(a[i] !== b[i]) return false;
      return true;
    }

    function recordAttempt(ok){
      var st = getStat(cur.id);
      st.attempts += 1;
      if(ok){
        st.correct += 1;
        st.failStreak = 0;
      } else {
        st.wrong += 1;
        st.failStreak = (st.failStreak || 0) + 1;
      }
      st.lastTs = Date.now();
    }

    function scheduleNext(){
      clearNextTimer();
      nextTimer = setTimeout(function(){
        pickNext();
      }, FEEDBACK_MS);
    }

    function check(){
      var t = getTenseById(cur.id);
      var expected = t.formula.slice();
      var ok = false;
      if(cur.id === "present_simple"){
        var alt = ["Person","base form (I) + s (he/she/it)"];
        ok = arraysEqual(cur.built, expected) || arraysEqual(cur.built, alt);
      } else {
        ok = arraysEqual(cur.built, expected);
      }

      recordAttempt(ok);
      updateHelpGateUI();

      if(ok){
        state.streak = (state.streak || 0) + 1;
        setFeedback("ok", "<strong>Richtig!</strong> Sehr gut.");
        save();
        renderAll();
        scheduleNext();
        return;
      }

      state.streak = 0;
      var msg = "<strong>Nicht ganz.</strong> ";
      if(cur.built.length === 0){
        msg += "Bitte baue zuerst die Formel zusammen.";
      } else {
        msg += "Versuche eine andere Reihenfolge oder andere Bausteine.";
      }
      setFeedback("bad", msg);
      save();
      renderAll();
    }

    function hint(){
      var st = getStat(cur.id);
      if((st.failStreak || 0) < 2){
        setFeedback("", "Noch kein Tipp verfügbar.");
        return;
      }
      var t = getTenseById(cur.id);
      var expected = t.formula;
      var i = cur.built.length;
      var nextTok = expected[Math.min(i, expected.length - 1)];
      if(cur.built.length > expected.length){
        setFeedback("", "<strong>Tipp:</strong> Zu viele Bausteine.");
        return;
      }
      setFeedback("", "<strong>Tipp:</strong> Nächster Baustein könnte sein: <span class='mono'>" + nextTok + "</span>.");
    }

    function showSolution(){
      var st = getStat(cur.id);
      if((st.failStreak || 0) < 5){
        setFeedback("", "Lösung noch gesperrt.");
        return;
      }
      var t = getTenseById(cur.id);
      var expected = t.formula.slice();
      setFeedback("bad", "<strong>Lösung:</strong> <span class='mono'>" + expected.join(" + ") + "</span>");
      if(state.settings.showCountsWrong){
        recordAttempt(false);
        state.streak = 0;
        updateHelpGateUI();
        save();
        renderAll();
      }
      scheduleNext();
    }

    function undo(){
      if(!cur.history.length) return;
      cur.built = cur.history.pop();
      renderFormula();
      clearFeedback();
    }

    function clearFormula(){
      cur.history.push(cur.built.slice());
      cur.built = [];
      renderFormula();
      clearFeedback();
    }

    function overallKpis(){
      var attempts = 0, correct = 0, covered = 0;
      for(var i=0;i<TENSES.length;i++){
        var st = getStat(TENSES[i].id);
        attempts += st.attempts || 0;
        correct += st.correct || 0;
        if((st.attempts || 0) > 0) covered++;
      }
      var acc = attempts ? Math.round((correct/attempts)*100) : 0;
      return { attempts: attempts, correct: correct, acc: acc, covered: covered, total: TENSES.length };
    }

    function topProblems(limit){
      var scored = TENSES.map(function(t){
        var st = getStat(t.id);
        var a = st.attempts || 0;
        var w = st.wrong || 0;
        var c = st.correct || 0;
        var err = a ? (w/a) : 1.0;
        var pct = a ? Math.round((c/a)*100) : 0;
        var score = (err*1.7) + (a===0 ? 1.1 : Math.max(0, 0.7 - Math.min(0.7, a/8)));
        return { t:t, score:score, attempts:a, pct:pct };
      });
      scored.sort(function(x,y){ return y.score - x.score; });
      return scored.slice(0, limit || 6).map(function(s){
        var info = (s.attempts === 0) ? "Neu" : (s.pct + "%");
        return "<button class='btn btn-ghost text-small' type='button' data-focus='" + s.t.id + "'>" +
          s.t.name + " (" + info + ")</button>";
      }).join("") || "-";
    }

    function statusForTense(t){
      var st = getStat(t.id);
      var a = st.attempts || 0;
      if(a === 0) return { cls:"status-new", label:"Neu" };
      var pct = Math.round((st.correct/a)*100);
      if(a < 3) return { cls:"status-bad", label:"Wackelig (" + pct + "%)" };
      if(pct >= 85) return { cls:"status-ok", label:"Sicher (" + pct + "%)" };
      return { cls:"status-bad", label:"Üben (" + pct + "%)" };
    }

    function renderOverview(){
      tenseList.innerHTML = "";
      TENSES.forEach(function(t){
        var st = statusForTense(t);
        var row = document.createElement("div");
        row.className = "tense-list-item";
        
        var content = document.createElement("div");
        content.innerHTML = "<strong>" + t.name + "</strong><div class='text-muted text-small'>" +
          t.formula.join(" + ") + "</div>";
        
        var badge = document.createElement("span");
        badge.className = "status-badge " + st.cls;
        badge.textContent = st.label;

        row.appendChild(content);
        row.appendChild(badge);

        row.addEventListener("click", function(){
          setFocus(t.id);
          save();
          openTab("train");
          pickNext();
          renderAll();
        });
        tenseList.appendChild(row);
      });
      var k = overallKpis();
      ovAttempts.textContent = String(k.attempts);
      ovCorrect.textContent = String(k.correct);
      ovAcc.textContent = k.attempts ? (k.acc + "%") : "-";
    }

    function openTab(which){
      var isTrain = (which === "train");
      var isOv = (which === "overview");
      var isSet = (which === "settings");

      tabTrain.setAttribute("aria-selected", isTrain ? "true" : "false");
      tabOverview.setAttribute("aria-selected", isOv ? "true" : "false");
      tabSettings.setAttribute("aria-selected", isSet ? "true" : "false");

      panelTrain.hidden = !isTrain;
      panelOverview.hidden = !isOv;
      panelSettings.hidden = !isSet;
      
      if(isOv) renderOverview();
      if(isSet) showCountsWrong.checked = !!state.settings.showCountsWrong;
    }

    function renderAll(){
      if(state.focusId) setFocus(state.focusId);
      else clearFocus();

      var k = overallKpis();
      streakEl.textContent = String(state.streak || 0);
      accEl.textContent = k.attempts ? (k.acc + "%") : "-";
      coveredEl.textContent = k.covered + "/" + k.total;
      savedAtEl.textContent = state.savedAt || "-";

      if(topListSettings){
        topListSettings.innerHTML = topProblems(6);
        topListSettings.querySelectorAll("button").forEach(function(btn){
          btn.addEventListener("click", function(){
            setFocus(btn.getAttribute("data-focus"));
            save();
            openTab("train");
            pickNext();
            renderAll();
          });
        });
      }
      showCountsWrong.checked = !!state.settings.showCountsWrong;
      updateHelpGateUI();
    }

    dropzone.addEventListener("dragover", function(e){
      e.preventDefault();
      dropzone.classList.add("is-over");
    });
    dropzone.addEventListener("dragleave", function(){
      dropzone.classList.remove("is-over");
    });
    dropzone.addEventListener("drop", function(e){
      e.preventDefault();
      dropzone.classList.remove("is-over");
      if(!dragging.token) return;
      cur.history.push(cur.built.slice());
      if(dragging.from === "pool"){
        cur.built.push(dragging.token);
      } else if(dragging.from === "formula"){
        var moved = cur.built.splice(dragging.index, 1)[0];
        cur.built.push(moved);
      }
      renderFormula();
      clearFeedback();
    });

    tabTrain.addEventListener("click", function(){ openTab("train"); });
    tabOverview.addEventListener("click", function(){ openTab("overview"); });
    tabSettings.addEventListener("click", function(){ openTab("settings"); });

    randomBtn.addEventListener("click", function(){ pickNext(); });
    checkBtn.addEventListener("click", function(){ check(); });
    undoBtn.addEventListener("click", function(){ undo(); });
    clearBtn.addEventListener("click", function(){ clearFormula(); });

    hintBtn.addEventListener("click", function(){ hint(); });
    showBtn.addEventListener("click", function(){ showSolution(); });

    clearFocusBtn.addEventListener("click", function(){
      clearFocus();
      save();
      pickNext();
      renderAll();
    });

    saveBtn.addEventListener("click", function(){ save(); renderAll(); });
    saveBtn2.addEventListener("click", function(){ save(); renderAll(); });
    resetBtn.addEventListener("click", function(){ resetAll(); });
    showCountsWrong.addEventListener("change", function(){
      state.settings.showCountsWrong = !!showCountsWrong.checked;
      save();
    });
    refreshBtn.addEventListener("click", function(){ renderOverview(); });

    load();
    renderTask();
    renderFormula();
    renderPool();
    renderAll();
    save();
    pickNext();
  })();
  </script>
</body>
</html>
