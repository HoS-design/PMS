<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>K√∂rperWerkstatt 3D ‚Ä¢ HoS</title>

  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --line:#d1d5db; --soft:#f8fafc;
      --card:#ffffff; --accent:#2563eb; --good:#10b981; --bad:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:linear-gradient(180deg,#fff,#f7fafc)}
    header{padding:18px 16px 10px;max-width:1200px;margin:0 auto;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .meme{width:78px;height:78px;object-fit:cover;border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);background:#fff}
    .titlewrap{flex:1;min-width:240px}
    h1{margin:0;font-size:22px;line-height:1.2}
    p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px;color:var(--muted)}
    .badge b{color:var(--accent)}
    .linkbtn{text-decoration:none;display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);font-weight:900}
    .wrap{max-width:1200px;margin:0 auto;padding:0 16px 18px;display:grid;grid-template-columns:410px 1fr;gap:14px}
    @media (max-width:980px){.wrap{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#fbfdff)}
    .hd h2{margin:0;font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .bd{padding:14px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    select,input[type="number"],input[type="text"]{width:100%;padding:10px 10px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff;color:var(--ink);font-size:14px}
    input[type="checkbox"]{transform:translateY(1px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:900;font-size:13px;color:var(--ink);box-shadow:0 6px 18px rgba(0,0,0,.06)}
    button.primary{background:var(--accent);color:#fff;border-color:transparent}
    button.good{background:var(--good);color:#fff;border-color:transparent}
    button.bad{background:var(--bad);color:#fff;border-color:transparent}
    .hint{margin-top:10px;padding:10px 12px;border-radius:14px;background:var(--soft);border:1px dashed var(--line);color:var(--muted);font-size:12px;line-height:1.35}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;font-size:12px;color:var(--muted);margin-top:10px}
    .kv b{color:var(--ink)}
    .canvasWrap{position:relative;min-height:520px;height:calc(100vh - 170px)}
    @media (max-width:980px){.canvasWrap{height:62vh}}
    #view{width:100%;height:100%}
    .overlay{position:absolute;left:12px;top:12px;display:flex;gap:8px;flex-wrap:wrap;pointer-events:none}
    .chip{pointer-events:none;background:rgba(255,255,255,.92);border:1px solid rgba(209,213,219,.9);border-radius:999px;padding:7px 10px;font-size:12px;color:var(--muted);box-shadow:0 8px 22px rgba(0,0,0,.08);backdrop-filter:blur(6px)}
    .chip b{color:var(--ink)}

    .modebar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border:1px solid var(--line);border-radius:999px;cursor:pointer;user-select:none;font-size:12px;color:var(--muted);font-weight:900}
    .pill.active{border-color:transparent;background:rgba(37,99,235,.12);color:var(--ink)}
    .taskBox{margin-top:10px;padding:12px 12px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,#fff,#fbfdff)}
    .taskTitle{font-size:12px;color:var(--muted);font-weight:1000;letter-spacing:.2px}
    .taskText{margin:6px 0 0;font-size:14px;font-weight:1000;line-height:1.25}
    .status{margin-top:10px;padding:10px 12px;border-radius:14px;border:1px dashed var(--line);background:var(--soft);color:var(--muted);font-size:12px;line-height:1.35;min-height:44px}
    .status.ok{border-color:rgba(16,185,129,.55);background:rgba(16,185,129,.08);color:#064e3b}
    .status.no{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.06);color:#7f1d1d}

    /* Error overlay */
    #err{display:none;position:fixed;inset:0;background:rgba(255,255,255,.98);z-index:9999;padding:18px}
    #err h3{margin:0 0 8px}
    #err pre{white-space:pre-wrap;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;max-width:1000px}
  </style>
</head>

<body>
<div id="err">
  <h3>‚ö†Ô∏è Die 3D-App konnte nicht starten.</h3>
  <p>Unten steht die genaue Fehlermeldung (hilft beim Debuggen):</p>
  <pre id="errText"></pre>
</div>

<header>
  <img class="meme" src="chatistthisreal.png" onerror="this.onerror=null;this.src='chatisthisreal.png';" alt="Chat is this real?">
  <div class="titlewrap">
    <span class="badge">üß± K√∂rperWerkstatt 3D ‚Ä¢ <b>HoS</b> ‚Ä¢ Aufgabenmodus</span>
    <h1>K√∂rperWerkstatt 3D</h1>
    <p>Klick: ausw√§hlen ‚Ä¢ Ziehen: verschieben ‚Ä¢ Aufgabenmodus: bauen ‚Üí Pr√ºfen</p>
  </div>
  <a class="linkbtn" href="index.html">üè† Startseite</a>
</header>

<main class="wrap">
  <section class="panel">
    <div class="hd"><h2>Steuerung <span style="color:var(--muted);font-weight:800">SuS</span></h2></div>
    <div class="bd">
      <div class="modebar">
        <span style="font-size:12px;color:var(--muted);font-weight:900">Modus:</span>
        <span class="pill active" id="pillFree">üß© Freies Bauen</span>
        <span class="pill" id="pillTask">üìù Aufgabenmodus</span>
      </div>

      <div class="taskBox" id="taskBox" style="display:none">
        <div class="taskTitle">Aufgabe</div>
        <div class="taskText" id="taskText">Klicke ‚ÄûNeue Aufgabe‚Äú.</div>

        <div class="btnbar">
          <button class="primary" id="newTask">üé≤ Neue Aufgabe</button>
          <button id="resetTask">üßº Reset</button>
          <button class="good" id="checkTask">‚úÖ Pr√ºfen</button>
        </div>

        <div class="status" id="status">Tipp: Stelle Ma√üe links ein ‚Üí ‚ÄûHinzuf√ºgen‚Äú.</div>
      </div>

      <div class="hd" style="margin:14px -14px 0;border-top:1px solid var(--line)"><h2>Werkzeugkasten <span style="color:var(--muted);font-weight:800">K√∂rper</span></h2></div>

      <label for="shape">K√∂rper</label>
      <select id="shape">
        <option value="box">Quader</option>
        <option value="cylinder">Zylinder</option>
        <option value="cone">Kegel</option>
        <option value="sphere">Kugel</option>
      </select>

      <div class="row">
        <div>
          <label id="labelA" for="a">Breite (a)</label>
          <input id="a" type="number" min="0.2" step="0.1" value="2.0">
        </div>
        <div>
          <label id="labelB" for="b">Tiefe (b)</label>
          <input id="b" type="number" min="0.2" step="0.1" value="2.0">
        </div>
      </div>

      <div class="row">
        <div>
          <label id="labelH" for="h">H√∂he (h)</label>
          <input id="h" type="number" min="0.2" step="0.1" value="2.0">
        </div>
        <div>
          <label for="seg">Segmente (rund)</label>
          <input id="seg" type="number" min="6" step="1" value="24">
        </div>
      </div>

      <div class="row">
        <div>
          <label><input id="snap" type="checkbox" checked> Snapping</label>
        </div>
        <div>
          <label for="grid">Raster</label>
          <input id="grid" type="number" min="0.25" step="0.25" value="0.5">
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="add">‚ûï Hinzuf√ºgen</button>
        <button class="bad" id="remove">üóëÔ∏è L√∂schen</button>
      </div>

      <div class="hint">
        Wenn Buttons ‚Äûtot‚Äú sind: √ñffne DevTools ‚Üí Console. Mit dieser Version siehst du den Fehler auch als Overlay.
      </div>

      <div class="kv" id="info">
        <div>Auswahl</div><div><b id="iSel">‚Äî</b></div>
        <div>Objekte</div><div><b id="iCount">0</b></div>
      </div>
    </div>
  </section>

  <section class="panel canvasWrap">
    <div class="overlay">
      <div class="chip">üéõÔ∏è <b>Orbit</b>: drehen</div>
      <div class="chip">üñ±Ô∏è <b>Drag</b>: ziehen</div>
      <div class="chip">üü® <b>Klick</b>: ausw√§hlen</div>
    </div>
    <div id="view"></div>
  </section>
</main>

<script type="module">
  // Robust ES-module imports (works reliably on GitHub Pages)
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js";
  import { DragControls } from "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/DragControls.js";

  const showErr = (e) => {
    const box = document.getElementById('err');
    const pre = document.getElementById('errText');
    pre.textContent = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
    box.style.display = 'block';
    console.error(e);
  };

  try{
    // UI refs
    const mount = document.getElementById("view");
    const elShape = document.getElementById("shape");
    const elA = document.getElementById("a");
    const elB = document.getElementById("b");
    const elH = document.getElementById("h");
    const elSeg = document.getElementById("seg");
    const elSnap = document.getElementById("snap");
    const elGrid = document.getElementById("grid");

    const labelA = document.getElementById("labelA");
    const labelB = document.getElementById("labelB");
    const labelH = document.getElementById("labelH");

    const btnAdd = document.getElementById("add");
    const btnRemove = document.getElementById("remove");

    const pillFree = document.getElementById("pillFree");
    const pillTask = document.getElementById("pillTask");
    const taskBox = document.getElementById("taskBox");
    const taskText = document.getElementById("taskText");
    const statusEl = document.getElementById("status");
    const btnNewTask = document.getElementById("newTask");
    const btnResetTask = document.getElementById("resetTask");
    const btnCheckTask = document.getElementById("checkTask");

    const iSel = document.getElementById("iSel");
    const iCount = document.getElementById("iCount");

    // Three.js
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(55, 1, 0.1, 200);
    camera.position.set(8, 7, 10);

    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    mount.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 1.2, 0);

    scene.add(new THREE.HemisphereLight(0xffffff, 0x9aa4b2, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(8, 12, 6);
    scene.add(dir);

    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(80, 80),
      new THREE.MeshStandardMaterial({ color: 0xf8fafc, roughness: 0.95, metalness: 0.0 })
    );
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    const gridHelper = new THREE.GridHelper(80, 80, 0xd1d5db, 0xe5e7eb);
    gridHelper.position.y = 0.001;
    scene.add(gridHelper);

    // State
    const objects = [];
    let selected = null;
    const matNormal = new THREE.MeshNormalMaterial();
    const edgeMat = new THREE.LineBasicMaterial({ color: 0xf59e0b });

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function roundTo(v, step){ return Math.round(v/step)*step; }

    function setStatus(t){ statusEl.textContent = t; }

    function updateBuilderLabels(){
      const s = elShape.value;
      if (s === "box"){
        labelA.textContent = "Breite (a)";
        labelB.textContent = "Tiefe (b)";
        labelH.textContent = "H√∂he (h)";
        elB.disabled = false; elH.disabled = false; elSeg.disabled = true;
      } else if (s === "cylinder"){
        labelA.textContent = "Radius (r)";
        labelB.textContent = "‚Äî";
        labelH.textContent = "H√∂he (h)";
        elB.disabled = true; elH.disabled = false; elSeg.disabled = false;
      } else if (s === "cone"){
        labelA.textContent = "Radius (r)";
        labelB.textContent = "‚Äî";
        labelH.textContent = "H√∂he (h)";
        elB.disabled = true; elH.disabled = false; elSeg.disabled = false;
      } else if (s === "sphere"){
        labelA.textContent = "Radius (r)";
        labelB.textContent = "‚Äî";
        labelH.textContent = "‚Äî";
        elB.disabled = true; elH.disabled = true; elSeg.disabled = false;
      }
    }
    elShape.addEventListener("change", updateBuilderLabels);
    updateBuilderLabels();

    function makeEdges(mesh){
      const e = new THREE.LineSegments(new THREE.EdgesGeometry(mesh.geometry, 20), edgeMat);
      e.visible = false;
      mesh.add(e);
      mesh.userData.edges = e;
    }

    function setSelected(obj){
      if (selected?.userData?.edges) selected.userData.edges.visible = false;
      selected = obj;
      if (selected?.userData?.edges) selected.userData.edges.visible = true;
      iSel.textContent = selected ? selected.userData.label : "‚Äî";
    }

    function refreshCounter(){
      iCount.textContent = String(objects.length);
    }

    let dragControls = null;
    function refreshDragControls(){
      if (dragControls){
        dragControls.deactivate();
        dragControls.dispose();
      }
      dragControls = new DragControls(objects, camera, renderer.domElement);

      dragControls.addEventListener("dragstart", () => controls.enabled = false);
      dragControls.addEventListener("dragend", () => controls.enabled = true);
      dragControls.addEventListener("drag", (ev) => {
        const obj = ev.object;
        obj.position.y = Math.max(obj.position.y, 0.01);
        if (elSnap.checked){
          const step = Math.max(0.05, parseFloat(elGrid.value || "0.5"));
          obj.position.x = roundTo(obj.position.x, step);
          obj.position.z = roundTo(obj.position.z, step);
        }
        setSelected(obj);
      });
    }

    function createMeshFromUI(){
      const shape = elShape.value;
      const a = clamp(parseFloat(elA.value || "2.0"), 0.1, 30);
      const b = clamp(parseFloat(elB.value || "2.0"), 0.1, 30);
      const h = clamp(parseFloat(elH.value || "2.0"), 0.1, 30);
      const seg = clamp(parseInt(elSeg.value || "24", 10), 6, 96);

      let geo, label;
      if (shape === "box"){
        geo = new THREE.BoxGeometry(a, h, b);
        label = `Quader`;
      } else if (shape === "cylinder"){
        geo = new THREE.CylinderGeometry(a, a, h, seg);
        label = `Zylinder`;
      } else if (shape === "cone"){
        geo = new THREE.CylinderGeometry(0, a, h, seg);
        label = `Kegel`;
      } else {
        geo = new THREE.SphereGeometry(a, seg, Math.floor(seg * 0.65));
        label = `Kugel`;
      }

      const mesh = new THREE.Mesh(geo, matNormal);
      mesh.userData.shape = shape;
      mesh.userData.label = label;
      return mesh;
    }

    function addObject(mesh){
      mesh.position.set(0, 1.2, 0);
      makeEdges(mesh);
      scene.add(mesh);
      objects.push(mesh);
      refreshDragControls();
      setSelected(mesh);
      refreshCounter();
    }

    btnAdd.addEventListener("click", () => addObject(createMeshFromUI()));

    btnRemove.addEventListener("click", () => {
      if (!selected) return;
      const idx = objects.indexOf(selected);
      if (idx >= 0) objects.splice(idx, 1);
      scene.remove(selected);
      selected = null;
      refreshDragControls();
      refreshCounter();
      iSel.textContent = "‚Äî";
    });

    // Picking
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    renderer.domElement.addEventListener("pointerdown", (e) => {
      const r = renderer.domElement.getBoundingClientRect();
      mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1;
      mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
      raycaster.setFromCamera(mouse, camera);
      const hits = raycaster.intersectObjects(objects, true);
      if (hits.length){
        let obj = hits[0].object;
        while (obj && !objects.includes(obj) && obj.parent) obj = obj.parent;
        if (objects.includes(obj)) setSelected(obj);
      }
    });

    // Mode: free vs task
    let mode = "free";
    function setMode(next){
      mode = next;
      pillFree.classList.toggle("active", mode === "free");
      pillTask.classList.toggle("active", mode === "task");
      taskBox.style.display = (mode === "task") ? "block" : "none";
    }
    pillFree.addEventListener("click", () => setMode("free"));
    pillTask.addEventListener("click", () => setMode("task"));

    // Very simple tasks (proof-of-life)
    const tasks = [
      { text: "Baue einen Zylinder (r=2, h=5).", shape:"cylinder", a:2, h:5 },
      { text: "Baue einen Quader (a=2, b=4, h=1).", shape:"box", a:2, b:4, h:1 },
      { text: "Baue einen Kegel (r=2, h=4).", shape:"cone", a:2, h:4 },
      { text: "Baue eine Kugel (r=2).", shape:"sphere", a:2 }
    ];
    let currentTask = null;

    btnNewTask.addEventListener("click", () => {
      setMode("task");
      currentTask = tasks[Math.floor(Math.random()*tasks.length)];
      taskText.textContent = currentTask.text;
      setStatus("Baue den K√∂rper, dann ‚ÄûPr√ºfen‚Äú.");
    });

    btnResetTask.addEventListener("click", () => {
      // clear all
      for (const m of objects) scene.remove(m);
      objects.length = 0;
      selected = null;
      refreshDragControls();
      refreshCounter();
      iSel.textContent = "‚Äî";
      setStatus("Szene geleert.");
    });

    btnCheckTask.addEventListener("click", () => {
      if (!currentTask){ setStatus("Keine Aufgabe aktiv. Klicke ‚ÄûNeue Aufgabe‚Äú."); return; }
      const ok = objects.some(m => m.userData.shape === currentTask.shape);
      setStatus(ok ? "‚úÖ K√∂rper passt (Form). (Ma√ü-Check kann ich wieder erg√§nzen.)" : "‚ùå Noch nicht. Baue den geforderten K√∂rper.");
    });

    // Resize + animate
    function resize(){
      const w = mount.clientWidth;
      const h = mount.clientHeight;
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    // starter object so you see it's alive
    addObject(createMeshFromUI());

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

  }catch(e){
    showErr(e);
  }
</script>
</body>
</html>